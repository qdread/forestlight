---
title: "Density and production scaling relationships"
author: "Quentin D. Read"
date: "March 16, 2017"
output: 
  pdf_document:
    toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Summary

## What I did

Below, I used the *poweRlaw* package to fit continuous Pareto (exponential) and lognormal distributions to density scaling relationships for BCI and Harvard Forest. I split each site into shade guilds and fit the same distributions. I plotted the two fits. 

In addition, I coded Ethan White's log-binning algorithm and binned production by biomass for BCI and Harvard. As before, I did this for all species, and for the three shade guilds at each site. 

Overall, it looks like the lognormal is a better fit in almost every case than the Pareto. It looks like the deviations from the lognormal at high biomasses match the results that Caroline Farrior got for the density scaling relationships. There might be some interesting differences in the fits between shade guilds for both the density scaling and the production scaling relationships. Also, the binned production plots do not seem to support the predictions of energy equivalence.

## What I will do

For now, I only estimated the $\alpha$ parameter for the Pareto distributions, and the $\mu$ and $\sigma$ parameters for the lognormal distributions. Each of them also has an $x_{min}$ parameter that can be estimated from the data, but for now, I just used the minimum value in the data as the $x_{min}$ parameter. I think that is appropriate but I can also try to estimate it from the data.

Also, there are no confidence intervals on the parameter estimates because I have not yet run the bootstraps. They will be added soon.

\newpage

# Preparing data

The biomass data are year 3. The production data are the increment of biomass between years 1 and 3, halved.

```{r, message=FALSE}
source('~/GitHub/forestlight/code/mergeshade.r')

pdat <- dat %>% 
  mutate(biomass3 = pmax(BiomassDGH_year3_kg, BiomassDBH_year3_kg, na.rm=TRUE),
         biomass2 = pmax(BiomassDGH_year2_kg, BiomassDBH_year2_kg, 0, na.rm=TRUE),
         biomass1 = pmax(BiomassDGH_year1_kg, BiomassDBH_year1_kg, 0, na.rm=TRUE),
         massprod23 = pmax(biomass3 - biomass2, 0, na.rm=TRUE),
         massprod12 = pmax(biomass2 - biomass1, 0, na.rm=TRUE),
         massprod13 = pmax((biomass3 - biomass1)/2, 0, na.rm=TRUE)) %>% 
  select(Site, biomass3, biomass2, massprod23, massprod12, massprod13, CII, tolerance)
bcidat <- pdat %>% filter(Site == 'Barro_Colorado_Island', !is.na(CII), !is.na(biomass3))
harvdat <- pdat %>% filter(Site == 'Harvard_Forest_LTER', !is.na(CII), !is.na(biomass3))
```

[Click to return to table of contents](#top)

\newpage

# Functions needed to run analysis

This function fits both continuous Pareto and continuous lognormal to the data (input as a single vector of values), and returns their parameters plus all data needed to plot them.

```{r}
powerlawfit <- function(dat) {
  library(poweRlaw)
  pl_dat <- conpl$new(dat)
  lognorm_dat <- conlnorm$new(dat)
  xmin_pl <- pl_dat$getXmin()
  xmin_lognorm <- lognorm_dat$getXmin()
  pars_pl <- estimate_pars(pl_dat)
  pars_lognorm <- estimate_pars(lognorm_dat)
  pl_dat$setPars(pars_pl)
  lognorm_dat$setPars(pars_lognorm)
  plotdat <- plot(pl_dat)
  plfit_dat <- lines(pl_dat)
  lognormfit_dat <- lines(lognorm_dat)
  
  return(list(plotdat = plotdat, 
              plfit = plfit_dat, 
              lognormfit = lognormfit_dat, 
              xmin = xmin_pl, 
              alpha = pars_pl$pars,
              xmin_lognorm = xmin_lognorm,
              pars_lognorm = pars_lognorm$pars))
}
```

\newpage
This function plots the data in a way that I think is nice.

```{r}
plotpowerlawfit <- function(pl, xl, title, subtitle) {
  library(ggplot2)
  th <- theme_bw() + theme(panel.grid = element_blank())
  
  expr1 <- as.character(as.expression(substitute(
    "Pareto:"~~alpha == a, list(a = round(pl$alpha, 2)))))
  expr2 <- as.character(as.expression(substitute(
    "Lognormal:"~~mu == m*","~~sigma == s, list(m = round(pl$pars_lognorm[1], 2), 
                                                s = round(pl$pars_lognorm[2], 2)))))

  p <- ggplot(pl$plotdat, aes(x = x, y = y)) +
    scale_x_log10() +
    scale_y_log10() +
    geom_point() +
    geom_line(data = subset(pl$plfit, y>0), color = 'forestgreen') +
    geom_line(data = subset(pl$lognormfit, y>0), color = 'indianred') +
    geom_text(x = -Inf, y = -Inf, label = expr1, parse = TRUE, hjust = 0, vjust = -1.5) +
    geom_text(x = -Inf, y = -Inf, label = expr2, parse = TRUE, hjust = 0, vjust = -0.25) +
    th +
    labs(x = xl, y = 'log CDF') +
    ggtitle(title, subtitle)
  return(p)
}
```

\newpage
This function implements Ethan White's log-binning algorithm. For our purposes, $x$ is biomass, $y$ is production, and $n$ is the desired number of bins.

```{r}
logbin <- function(x, y, n) {
  logx <- log10(x)                                           # log transform x value (biomass)
  bin_edges <- seq(min(logx), max(logx), length.out = n + 1) # get edges of bins
  logxbin <- rep(NA, length(logx))                           # create data structure to assign trees to bins
  b <- bin_edges                                             # add a little to the biggest bin temporarily
  b[length(b)] <- b[length(b)] + 1                           # (so that the biggest single tree is put in a bin)
  for (i in 1:length(logx)) {
    logxbin[i] <- sum(logx[i] >= b)                          # assign each tree to a bin
  }
  bin_midpoints <- numeric(n)
  for (i in 1:n) {
    bin_midpoints[i] <- mean(10^(bin_edges[i:(i+1)]))        # backtransform bin edges to linear, and get midpoints
  }
  bin_widths <- diff(10^bin_edges)                           # get linear width of each bin
  bin_factor <- factor(logxbin, levels=1:n)                  # convert bin to factor (required to deal with zeroes if present)
  rawy <- tapply(y, bin_factor, sum)                         # sum y value (production) in each bin
  rawy[is.na(rawy)] <- 0                                     # add zeroes back in if present
  
  bin_counts <- table(bin_factor)                            # find number of trees in each bin
  
  return(data.frame(bin_midpoint = bin_midpoints,            # divide production by width for each bin, and return result!
                    bin_value = as.numeric(rawy/bin_widths), # also add bin min and max for bar plot purposes
                    bin_count = as.numeric(bin_counts),
                    bin_min = 10^bin_edges[1:n],
                    bin_max = 10^bin_edges[2:(n+1)]))
  
}
```

This is a verbal description of the binning algorithm given in R code above.

1. Log transform the year 3 biomass data
2. Bin into equal width bins (on the logarithmic axis)
3. Back transform the bin edges to linear axis.
4. Get the midpoint of each bin. This is the X-value on the plot.
5. Sum the biomass production of each bin, expressed as (year 3 biomass - year 1 biomass)/2
6. Divide each bin's summed production value by the linear width of each bin (this will be the Y-value on the plot).

\newpage
Finally, this function plots the log bins as a histogram.

```{r}
plotlogbin <- function(dat, xl, yl, title, subtitle, ymax) {
  library(ggplot2)
  th <- theme_bw() + theme(panel.grid = element_blank())
  
  p <- ggplot(dat, aes(xmin=bin_min, xmax=bin_max, ymin=0, ymax=bin_value)) + 
    geom_rect() +
    scale_x_log10(name = xl, expand = c(0,0)) +
    scale_y_continuous(name = yl, expand = c(0,0), limits = c(0,ymax)) +
    th + ggtitle(title, subtitle)
  return(p)
}
```

[Click to return to table of contents](#top)

\newpage

# Results

## Density scaling relationships

Below, I fit all the power laws at once, then plot the results. **Note: For all plots below, the green line is the Pareto fit and the red line is the lognormal fit.**

```{r, results='hide', fig.keep = 'none'}
bci_abund_all <- powerlawfit(bcidat$biomass3)
bci_abund_shade <- powerlawfit(subset(bcidat, tolerance == 'S')$biomass3)
bci_abund_inter <- powerlawfit(subset(bcidat, tolerance == 'I')$biomass3)
bci_abund_gap <- powerlawfit(subset(bcidat, tolerance == 'G')$biomass3)
harv_abund_all <- powerlawfit(harvdat$biomass3)
harv_abund_shade <- powerlawfit(subset(harvdat, tolerance == 'S')$biomass3)
harv_abund_inter <- powerlawfit(subset(harvdat, tolerance == 'I')$biomass3)
harv_abund_gap <- powerlawfit(subset(harvdat, tolerance == 'G')$biomass3)
```

\newpage

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.width = 3.25, fig.height = 3.25}
plotpowerlawfit(bci_abund_all, 'Biomass (kg)', 'Density scaling, BCI','all species')
plotpowerlawfit(bci_abund_shade, 'Biomass (kg)', 'Density scaling, BCI', 'shade-tolerant species')
plotpowerlawfit(bci_abund_inter, 'Biomass (kg)', 'Density scaling, BCI', 'intermediate species')
plotpowerlawfit(bci_abund_gap, 'Biomass (kg)', 'Density scaling, BCI', 'gap species')
plotpowerlawfit(harv_abund_all, 'Biomass (kg)', 'Density scaling, Harvard', 'all species')
plotpowerlawfit(harv_abund_shade, 'Biomass (kg)', 'Density scaling, Harvard', 'shade-tolerant species')
plotpowerlawfit(harv_abund_inter, 'Biomass (kg)', 'Density scaling, Harvard', 'intermediate species')
plotpowerlawfit(harv_abund_gap, 'Biomass (kg)', 'Density scaling, Harvard', 'gap species')
```

[Click to return to table of contents](#top)

\newpage

## Production scaling relationships

For binning, I tried to create 20 bins if possible. Anything more resulted in zeroes in some bins (due to the limited sample size), which means that you cannot fit power laws to the data. So for some of the guilds with few individuals, there are less than 20 bins. I generated all the bins and fit all the power laws at once, then plotted the results. **As before, the green line is Pareto and the red is lognormal.** I also plotted the bins as a histogram on a logarithmic scale.

```{r, results = 'hide', fig.keep = 'none'}
numbins <- 20

bci_logbin <- with(bcidat, logbin(biomass3, massprod13, numbins))
bci_production_all <- powerlawfit(bci_logbin$bin_value)
bci_logbin_shade <- with(subset(bcidat, tolerance == 'S'), logbin(biomass3, massprod13, numbins))
bci_production_shade <- powerlawfit(bci_logbin_shade$bin_value)
bci_logbin_inter <- with(subset(bcidat, tolerance == 'I'), logbin(biomass3, massprod13, 15))
bci_production_inter <- powerlawfit(bci_logbin_inter$bin_value)
bci_logbin_gap <- with(subset(bcidat, tolerance == 'G'), logbin(biomass3, massprod13, 15))
bci_production_gap <- powerlawfit(bci_logbin_gap$bin_value)
harv_logbin <- with(harvdat, logbin(biomass3, massprod13, numbins))
harv_production_all <- powerlawfit(harv_logbin$bin_value)
harv_logbin_shade <- with(subset(harvdat, tolerance == 'S'), logbin(biomass3, massprod13, numbins))
harv_production_shade <- powerlawfit(harv_logbin_shade$bin_value)
harv_logbin_inter <- with(subset(harvdat, tolerance == 'I'), logbin(biomass3, massprod13, 10))
harv_production_inter <- powerlawfit(harv_logbin_inter$bin_value)
harv_logbin_gap <- with(subset(harvdat, tolerance == 'G'), logbin(biomass3, massprod13, 8))
harv_production_gap <- powerlawfit(harv_logbin_gap$bin_value)
```

\newpage

```{r, message = FALSE, warning = FALSE, echo = FALSE, fig.width = 3.25, fig.height = 3.25}
plotpowerlawfit(bci_production_all, 'Biomass production (kg/y)', 'Production scaling, BCI', 'all species')
plotlogbin(bci_logbin, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, BCI', 'all species', 160)
plotpowerlawfit(bci_production_shade, 'Biomass production (kg/y)', 'Production scaling, BCI', 'shade-tolerant species')
plotlogbin(bci_logbin_shade, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, BCI', 'shade-tolerant species', 70)
plotpowerlawfit(bci_production_inter, 'Biomass production (kg/y)', 'Production scaling, BCI', 'intermediate species')
plotlogbin(bci_logbin_inter, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, BCI', 'intermediate species', 8)
plotpowerlawfit(bci_production_gap, 'Biomass production (kg/y)', 'Production scaling, BCI', 'gap species')
plotlogbin(bci_logbin_gap, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, BCI', 'gap species', 4)
plotpowerlawfit(harv_production_all, 'Biomass production (kg/y)', 'Production scaling, Harvard', 'all species')
plotlogbin(harv_logbin, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, Harvard', 'all species', 40)
plotpowerlawfit(harv_production_shade, 'Biomass production (kg/y)', 'Production scaling, Harvard', 'shade-tolerant species')
plotlogbin(harv_logbin_shade, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, Harvard', 'shade-tolerant species', 40)
plotpowerlawfit(harv_production_inter, 'Biomass production (kg/y)', 'Production scaling, Harvard', 'intermediate species')
plotlogbin(harv_logbin_inter, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, Harvard', 'intermediate species', 2)
plotpowerlawfit(harv_production_gap, 'Biomass production (kg/y)', 'Production scaling, Harvard', 'gap species')
plotlogbin(harv_logbin_gap, 'Biomass (kg)', 'Biomass production (kg/y)', 'Production bins, Harvard', 'gap species', 0.3)
```

[Click to return to table of contents](#top)