# Reproducible example for log binning thing.

x <- c(2.4, 2.7, 12, 3, 2.8, 2.1, 18.4, 1.5, 6.6, 1.5, 14.1, 7.9, 
       5.3, 2.2, 1.6, 8.1, 8.5, 2.2, 7.6, 3.1, 4.1, 1.5, 15.6, 3.6, 
       5, 2.2, 2.2, 10, 3.6, 2.8, 3, 2.4, 14.5, 4.6, 4.4, 5.4, 10.6, 
       1.5, 2.5, 5.1, 2.6, 5.3, 1.8, 2, 21.4, 1.7, 2.1, 8.1, 2.3, 1.5, 
       13.8, 2.9, 3, 5.7, 1.3, 3.9, 1.5, 4.6, 5.6, 3.4, 1.7, 5.1, 2.1, 
       5.6, 3.5, 11.6, 1.4, 1.6, 1.7, 1.4, 2.4, 14.8, 1.7, 26.5, 1.8, 
       11.4, 3.2, 1.5, 1.8, 6.4, 1.1, 1.4, 1.4, 5.2, 3.7, 1.2, 1.5, 
       2.9, 1.5, 3.3, 1.6, 1.2, 2.6, 1.7, 2.2, 1.6, 5.5, 1.4, 1.2, 1.9, 
       1.7, 1.7, 7.8, 3.4, 1.9, 11.7, 5, 2, 5.9, 13.7, 6.2, 2.2, 1.3, 
       7.6, 10.5, 2.9, 1.6, 8, 10.9, 5.6, 3.7, 7.3, 1.2, 22.7, 1.9, 
       2.1, 3.5, 2.5, 8.9, 4.5, 1.4, 2.1, 3.4, 1.6, 2, 3.7, 2.4, 1.7, 
       4.3, 8.4, 47.5505211645945, 2.1, 2.2, 4.1, 13.6, 13.9, 10.8, 
       11.1, 1.7, 1.4, 3.4, 1.3, 10.9, 1.7, 9.3, 1.4, 2.8, 2.7, 7.4, 
       2.1, 2.8, 9.8, 1.4, 2.5, 2.4, 1.3, 1.1, 3, 8, 2.3, 2.8, 5.6, 
       2.2, 2.3, 5, 1.8, 8.5, 2.8, 2.2, 13, 10.5, 3.7, 6.4, 55, 2.1, 
       1.1, 14.1, 4.1, 1.3, 1.2, 2.3, 4.3, 1.5, 8.6, 5.1, 2, 1.5, 11, 
       7.6, 4.3, 2.1, 1.7, 3.2, 2.8, 1.2, 3.7, 3.4, 2.4, 1.7, 1.9, 3, 
       1.7, 13.1, 7.8, 8, 18, 6.4, 2.4, 12.2, 1.3, 1.3, 5.3, 22.4, 2.2, 
       1.2, 5.1, 9.8, 7.9, 2.6, 7.2, 1.8, 2.2, 50.8, 1.9, 18.2, 7.2, 
       5, 13.1, 8.7, 1.4, 3.8, 2.6, 1.8, 11.2, 2, 9.4, 10, 2.4, 1.4, 
       10, 3.1, 4.1, 3.7, 4.8, 7.1, 4.7, 1.3, 1.7, 5.6, 1.4, 3.4, 9.5, 
       4.5, 5.5, 12.8, 1.8, 3.2, 1.4, 5.6, 1.2, 8.9, 1.7, 1.5, 13.7, 
       1.7, 1.3, 1.4, 5.9, 1.9, 1.8, 2.2, 1.1, 3, 3, 4.1, 3.9, 1.6, 
       1.6, 2, 7.3, 7.9, 4.6, 10.7, 2, 2.3, 6, 2, 12, 4.8, 2.1, 1.5, 
       11.8, 3.4, 1.4, 2.4, 1.2, 3.4, 2.9, 2.3, 2.7, 2.2, 4.1, 1.6, 
       1.5, 2.9, 1.9, 4.2, 2.9, 7.4, 2.2, 4.4, 2.4, 1.8, 14.7, 1.4, 
       2.7, 3.2, 3.2, 2, 5.6, 2.4, 1.9, 1.2, 2.4, 1.3, 9, 1.3, 4.5, 
       1.3, 11.4, 3.2, 1.6, 8.4, 2.5, 2.7, 2.5, 73.5509249542083, 1.8, 
       2.6, 2.2, 26.0154160434286, 12.9, 1.5, 9.6, 3, 1.5, 3.7, 3.5, 
       2.2, 4.4, 2.2, 5.1, 20.8, 3.8, 25.3, 1.2, 1.9, 1.8, 5.6, 1.9, 
       6.2, 1.6, 3.1, 3.3, 3.3, 2.2, 11.2, 9.8, 4, 13, 2.7, 3, 4.3, 
       2.5, 3.4, 4.4, 1.6, 2.2, 3.7, 1.8, 3.9, 2.4, 2, 1.6, 3.6, 2.6, 
       1.9, 27, 1.7, 3.5, 57.7955543317918, 2.3, 7.5, 87.0295721053834, 
       1.4, 8.1, 1.3, 1.4, 1.4, 18.5, 2, 3.7, 10.5, 1.7, 4.1, 28.9, 
       2.6, 8, 1.2, 1.7, 1.6, 3.9, 3.1, 2.2, 4.3, 5.1, 1.1, 1.9, 3.4, 
       4.1, 5.3, 4.3, 1.3, 1.3, 13.9, 52.6, 85.7785183032233, 2.5, 4.9, 
       3, 2.4, 2.5, 5.4, 2, 1.3, 4.7, 3.9, 2.8, 1.1, 9.3, 3.5, 2.5, 
       2.8, 1.9, 2.4, 1.2, 29.9, 1.7, 3.3, 1.9, 4.4, 7.8, 9, 27.1, 1.3, 
       1.7, 2.9, 1.4, 59.2255158917635, 2.8, 2.1, 14.4, 12.5, 2.6, 2.3, 
       4.5, 1.5, 2.8, 1.6, 1.3, 5.4, 2.3, 4.2, 1.3, 4, 2.1, 4.6, 2.5, 
       4.4, 9.4, 3.4, 5.2, 1.4, 3.4, 2.7, 14.8, 11.3, 2.1, 1.4, 18)

y <- c(0.0505709301226872, 0.0182007921226895, 1.87026997942014, 0.0598934719816852, 
       0.0190783191175209, 0.0123291781492931, 9.01424481528504, 0.0140866283425346, 
       0.797091605293012, 0.00579377330610581, 3.56714618757582, 0.11323699250812, 
       0.288618081760397, 0.0318020427277766, 0.0167859125542264, 0.491104079920479, 
       0.947721923051575, 0.0385311345355921, 1.00529342665122, 0.0285354691943226, 
       0.128826563185604, 0.0130087565077924, 8.73832260639665, 0.0572090410589901, 
       0.141998833631439, 0.0112735135690309, 0.0152174807578142, 1.18838024296223, 
       0.096216905156858, 0.0547752118903303, 0.0862750058003086, 0.037572260010078, 
       0.909567366721334, 0.204845583828955, 0.0391757260809057, 0.0538016163083455, 
       0.152422581421386, 0.00952416196386155, 0.0170161108219235, 0.0555967323901197, 
       0.0282275579275182, 0.215656274152276, 0.00875841395846965, 0.0178414196622004, 
       10.1923320181217, 0.00748763235600445, 0.0115770151391876, 0.745477194920166, 
       0.0365659132421239, 0.0055987300092015, 2.33517289079998, 0.0843855034522404, 
       0.034619037451329, 0.1241943496147, 0.0091923285732494, 0.135463082091095, 
       0.0156724784712271, 0.308944074944068, 0.438689595429753, 0.0848094725442313, 
       0.00603390549073137, 0.0655367282492011, 0.0172681172876384, 
       0.290439578097898, 0.103578972809568, 2.39857990341755, 0.00838232163600677, 
       0.0158483722847164, 0.0177608230767095, 0.00536480390470498, 
       0.0138822640569073, 3.02863984391909, 0.0198390733446781, 16.163652265606, 
       0.0187193980793516, 1.70761743767291, 0.0943887437593583, 0.00952416196386155, 
       0.0137882990657284, 0.502882533347007, 0.00412177739800727, 0.0115846957000857, 
       0.0098334478979854, 0.501809431650476, 0.120123051891132, 0.00359739125289813, 
       0.0055987300092015, 0.0850432135334653, 0.0113472517213035, 0.044181903668876, 
       0.0159865649392219, 0.00394334594175927, 0.0499049759155799, 
       0.022883603198878, 0.0370638301950516, 0.0129522089135538, 0.310562836454457, 
       0.0112052897064615, 0.00409021963296081, 0.026970879711924, 0.0069569084111847, 
       0.012963362409377, 0.316044713939196, 0.0248013286501681, 0.0160679790157246, 
       2.71461118942992, 0.145321232763201, 0.0202451552162136, 0.284825900097895, 
       5.47218991398201, 0.222845497829209, 0.0451050804876058, 0.00505303216604153, 
       0.640682198212193, 0.962939895264546, 0.0185612994967397, 0.012987210825081, 
       1.03994966513508, 2.13447892724551, 0.297687500058428, 0.243552722139126, 
       1.04805406779832, 0.00400472288346676, 12.4603364363619, 0.0085984934738949, 
       0.0135642619797802, 0.171433324064693, 0.0269693124508277, 0.451420296618824, 
       0.242527668134798, 0.0115361915894918, 0.036596978966347, 0.110639884133754, 
       0.00654555830547108, 0.0169924966854076, 0.0324819760019581, 
       0.0112911599748265, 0.0073357017513412, 0.282531223077501, 0.910765525497948, 
       3.66377890211411, 0.0140491935726539, 0.0276236735189867, 0.124706511714279, 
       0.524361497552195, 0.36775342380399, 0.551733360395379, 2.53301557263428, 
       0.00698665745523024, 0.0123983460085907, 0.124744764695832, 0.00500258925843875, 
       0.427610412579084, 0.0236366160102751, 0.29227372421484, 0.00446909880040028, 
       0.0158700375469873, 0.0831591085444623, 0.173000234105819, 0.0135638486828644, 
       0.0302530293268754, 1.02360291165194, 0.0129140707985483, 0.0275010193101471, 
       0.0157525912122339, 0.00352809191489614, 0.00325829219346325, 
       0.0182988149808249, 1.3515799283154, 0.0431371412260359, 0.111112149725073, 
       0.350566870456961, 0.047918227793839, 0.0128425515369359, 0.0490191136846363, 
       0.00718008803221831, 0.478318291231291, 0.0450989774350112, 0.0333853344377776, 
       0.99638375898909, 0.973695286849957, 0.175255732368663, 0.259067087855505, 
       66.1341966722186, 0.0314856886599644, 0.00349264783002168, 4.76150070148515, 
       0.140693834204532, 0.00741411886248269, 0.0039838062630843, 0.0223143063499102, 
       0.175731020196634, 0.0154095235730514, 0.252646630085139, 0.0409234934830773, 
       0.00945646600792265, 0.0055180964051077, 0.197576341732154, 0.92650258239196, 
       0.102600867642016, 0.0210639923647032, 0.0146462899855788, 0.023362724057065, 
       0.0174959741840116, 0.00359739125289813, 0.0287120927815812, 
       0.123318985390024, 0.0451819691535463, 0.0194095643453472, 0.0366269080559417, 
       0.0859173408299597, 0.00698665745523024, 0.768262488777115, 0.807388180976964, 
       0.217194835541674, 2.95993378775297, 0.156319381797474, 0.0157525912122339, 
       0.681820037805404, 0.00424094724952001, 0.00419885550318713, 
       0.148947752186653, 13.9554291461994, 0.033223415438388, 0.00377711222902292, 
       0.140607199867241, 1.78963610591963, 0.498424553032128, 0.054951285609426, 
       0.447562874163361, 0.0211391754126278, 0.0189066685605166, 50.5524262468002, 
       0.0116735662211314, 4.76799656044144, 0.556697300828645, 0.207613559533059, 
       0.178527874783153, 1.31069546418779, 0.00821842770162419, 0.14321948400216, 
       0.0629690849803203, 0.0127332546043739, 1.65998454321199, 0.00873288204458636, 
       1.15960653085648, 1.40523074031561, 0.0346056329644829, 0.0109262730709657, 
       0.424935228427882, 0.024700565726386, 0.0784389269900087, 0.0528248511844407, 
       0.0510999813919848, 0.0830142074471699, 0.31425459866468, 0.00570048903546057, 
       0.00777775477364695, 0.384841951743449, 0.00870862635361296, 
       0.0690938294771824, 1.66084533768945, 0.107726749334708, 0.249162213664716, 
       2.0099310195487, 0.0132473865811989, 0.0563226455751378, 0.00866590889527163, 
       0.495838526069084, 0.00736482167419687, 1.2870401252465, 0.00705669573425579, 
       0.0102070874007214, 0.146794117935056, 0.0184860265633615, 0.0048188291471665, 
       0.015563953372795, 0.126400731763925, 0.0102443942304307, 0.0077419056703914, 
       0.0189066685605166, 0.00303601105148636, 0.0388342276209017, 
       0.0682756438060944, 0.0319419651118062, 0.0602759874650202, 0.0147717671096751, 
       0.0114143750596755, 0.0169924966854076, 1.03862098648173, 0.517757917533494, 
       0.201895372320331, 0.260484732556073, 0.0178414196622004, 0.0308331770889656, 
       0.132164360231155, 0.025199361879005, 1.38510035442626, 0.11943847020361, 
       0.0251965227647029, 0.0055180964051077, 2.30538816096717, 0.100979328439235, 
       0.0114152537682275, 0.0374231348829837, 0.00365350824034623, 
       0.186223527301749, 0.0461785795659222, 0.0128425515369359, 0.0540065020160715, 
       0.0276356543373493, 0.0469584861799016, 0.00902636220481137, 
       0.00354740501549954, 0.0553980218995566, 0.0281420529303833, 
       0.0722208364504063, 0.0637207358888007, 0.66723935559569, 0.0342278031711622, 
       0.123893082460478, 0.0272846061845666, 0.0187193980793516, 6.2872546651527, 
       0.0104063837103501, 0.0189983635877777, 0.0672738756352414, 0.101605572739048, 
       0.0256332359334488, 0.121008583321994, 0.0331367483733425, 0.0090280629957216, 
       0.00358207363477855, 0.0392545043492476, 0.00741411886248269, 
       0.965659701754273, 0.00706134335614956, 0.0376366688245385, 0.00467429076679862, 
       2.28239928276232, 0.0418487766507979, 0.0147717671096751, 0.523798605399511, 
       0.0586709836624447, 0.0712254860311861, 0.0564829141066576, 43.8462298252169, 
       0.0263398432372086, 0.0439618398070793, 0.0112735135690309, 15.1144856065802, 
       3.52856150028598, 0.0113472517213035, 1.815333432561, 0.102126762817025, 
       0.0128561295936621, 0.0288348710707745, 0.0932335983239549, 0.0277417975234503, 
       0.112438337783291, 0.0277417975234503, 0.222744690119208, 8.24271900273379, 
       0.0881472504518879, 9.82430969106063, 0.00624674265389902, 0.0239425655357855, 
       0.00926328353851257, 0.156467861533977, 0.0085984934738949, 0.367316521316254, 
       0.0108712610341465, 0.0210186022843437, 0.126015613543307, 0.0903886136860386, 
       0.0503189398822347, 0.773148827320741, 0.935817438476324, 0.0849605512880393, 
       2.19557711119431, 0.019516978861477, 0.0535526211961717, 0.0424878118932895, 
       0.013265084784752, 0.0759633045748873, 0.0409123062588591, 0.00502765281620266, 
       0.0104108938946017, 0.091600913328164, 0.02167398792401, 0.214687032893837, 
       0.0331367483733425, 0.00945646600792265, 0.0108712610341465, 
       0.169996108953223, 0.0408712386077383, 0.00989176556467143, 1.64076375152594, 
       0.00708875051954542, 0.0745523994201841, 165.269517486877, 0.0223143063499102, 
       0.911548671621834, 80.6335734423547, 0.00576574119481152, 1.36489518823757, 
       0.00387757009868959, 0.00481879068739894, 0.00314049940642976, 
       3.89235124555831, 0.0308665950653101, 0.0972381712335425, 0.275791378200021, 
       0.00546920843311303, 0.160324681511973, 7.04364521966017, 0.0302516013449109, 
       1.55039678887866, 0.00332212831447456, 0.0160741073170787, 0.0174616559911188, 
       0.156990463394571, 0.0285354691943226, 0.0277417975234503, 0.107726673201536, 
       0.401376444522083, 0.00303601105148636, 0.0174588004988463, 0.0942005739965933, 
       0.224899981239285, 0.203022645275361, 0.075370129498801, 0.0076999748930882, 
       0.00741411886248269, 4.21681423671253, 60.9866733663418, 135.789000439173, 
       0.0303769450939143, 0.0880239885313458, 0.0191180351911786, 0.0441124665545316, 
       0.033229737963153, 0.0304530699937636, 0.0365107381812205, 0.0088236447647649, 
       0.175392564311956, 0.029236574709816, 0.0876637183854643, 0.002555990524565, 
       0.375751763920899, 0.0354591133509699, 0.0290361613340248, 0.0819222299830818, 
       0.0225212288059818, 0.0421680281974317, 0.00375685628308606, 
       2.88721538960468, 0.0073357017513412, 0.0235121118150243, 0.0325051272219163, 
       0.182768311917169, 0.234586127319386, 0.141199653141254, 12.1994184497391, 
       0.00741411886248269, 0.0122931650251884, 0.0253071202595434, 
       0.00508116669008719, 124.923615755231, 0.0788842189195772, 0.0196330818093814, 
       1.45914697962919, 0.480828044073657, 0.0724893245111271, 0.0421752217065279, 
       0.0813903269766617, 0.0055180964051077, 0.0452324263801614, 0.0108712610341465, 
       0.00440862484896841, 0.447004825605365, 0.0145728004923473, 0.0386801685421417, 
       0.00878084911967403, 0.118882412519807, 0.0186989087128005, 0.211981801857083, 
       0.0570018310781287, 0.182768311917169, 0.169884790732825, 0.0194146681263675, 
       0.0608776212443944, 0.00326020051499567, 0.03367100914233, 0.0151278567438572, 
       6.95803632259013, 2.01449395524289, 0.028383440514336, 0.0081100932010686, 
       7.79930985877141)

x_min <- min(x) #1.1
# truncation for Weibull
LL <- 1.1
UL <- 316
N <- length(x)

# Stan model: compile
library(rstan)
library(bayesplot)
library(loo)
library(purrr)
options(mc.cores = 3)
rstan_options(auto_write = TRUE)

mod <- stan_model('stan/model_wpow_withlik.stan')
dat <- list(x=x, y=y, N=N, LL=LL, UL=UL)

# Fit stan model
fit <- sampling(mod, data = dat, iter = 2000, chains = 3, pars = c('log_lik_prod','log_lik_dens'), include = FALSE)

summary(fit) # Looks good.

x_pred <- exp(seq(log(LL),log(UL),length.out=25))

pars <- as.data.frame(extract(fit))

trunc_pts <- pmap(pars, function(m, n, ...) pweibull(q = c(LL,UL), shape = m, scale = n))
dens_fitted <- sapply(x_pred, dweibull, shape = pars[,'m'], scale = pars[,'n']) 
dens_fitted <- t(sapply(1:nrow(dens_fitted), function(i) {
    x <- dens_fitted[i,]/diff(trunc_pts[[i]])
    x
}))

powerlaw_log <- function(x, beta0, beta1) exp(-beta0) * x^beta1

prod_fitted <- sapply(x_pred, powerlaw_log, beta0 = pars[,'beta0'], beta1 = pars[,'beta1']) # Fitted production values for a lot of x values

totalprod_fitted <- dens_fitted * prod_fitted

plot(x_pred,totalprod_fitted[1,],log='xy')

logbin_setedges <- function(x, y = NULL, bin_edges) {
  logx <- log10(x)                                           # log transform x value (biomass)
  bin_edges <- log10(bin_edges)
  n <- length(bin_edges) - 1
  logxbin <- rep(NA, length(logx))                           # create data structure to assign trees to bins
  b <- bin_edges                                             # add a little to the biggest bin temporarily
  b[length(b)] <- b[length(b)] + 1                           # (so that the biggest single tree is put in a bin)
  for (i in 1:length(logx)) {
    logxbin[i] <- sum(logx[i] >= b)                          # assign each tree to a bin
  }
  bin_midpoints <- 10^(bin_edges[-1] - diff(bin_edges)/2)
  bin_widths <- diff(10^bin_edges)                              # get linear width of each bin
  bin_factor <- factor(logxbin, levels=1:n)                  # convert bin to factor (required to deal with zeroes if present)
  bin_counts <- table(bin_factor)                            # find number of trees in each bin
  if (!is.null(y)) {
    rawy <- tapply(y, bin_factor, sum)                       # sum y value (production) in each bin
    rawy[is.na(rawy)] <- 0                                   # add zeroes back in if present
    bin_values <- as.numeric(rawy/bin_widths)                # divide production by width for each bin 
  }
  else {
    bin_values <- as.numeric(bin_counts/bin_widths)          # 1-dimensional case.
  }
  
  return(data.frame(bin_midpoint = bin_midpoints,            # return result!
                    bin_value = bin_values,                  # also add bin min and max for bar plot purposes
                    bin_count = as.numeric(bin_counts),
                    bin_min = 10^bin_edges[1:n],
                    bin_max = 10^bin_edges[2:(n+1)]))
  
}


# Draw n times from the truncated weibull
library(truncdist)
dbhs <- rtrunc(N, 'weibull', a = LL, b = UL, shape = mean(pars$m), scale = mean(pars$n))
prods <- powerlaw_log(dbhs, beta0 = mean(pars$beta0), beta1 = mean(pars$beta1))


fitted_bin <- logbin_setedges(dbhs, prods, exp(seq(log(LL),log(UL),length.out=10)))
obs_bin <- logbin_setedges(x, y, exp(seq(log(LL),log(UL),length.out=10)))

ggplot(data.frame(x = fitted_bin$bin_midpoint, y = c(fitted_bin$bin_value, obs_bin$bin_value), g = rep(c('p','o'),each=9)), aes(x,y,group=g,color=g)) + geom_point() + theme_classic() + scale_x_log10() + scale_y_log10()


dbhs_alldraws <- pmap(pars, function(m, n, ...) rtrunc(N, 'weibull', a = LL, b = UL, shape = m, scale = n))
prods_alldraws <- lapply(1:length(dbhs_alldraws), function(i) powerlaw_log(dbhs_alldraws[[i]], beta0 = pars$beta0[i], beta1  = pars$beta1[i]))

fitted_bin_alldraws <- map2(dbhs_alldraws, prods_alldraws, ~ logbin_setedges(.x, .y, exp(seq(log(LL),log(UL),length.out=10))))

# Map out bin values to get quantiles for each bin  
binvalues <- do.call(rbind, map(fitted_bin_alldraws, 'bin_value'))
binquantiles <- apply(binvalues, 2, quantile, probs = c(0.025, 0.5, 0.975)) %>% t %>% as.data.frame %>% setNames(c('q025','q50','q975'))

ggplot(cbind(obs_bin, binquantiles)) +
  geom_point(aes(x=bin_midpoint, y = bin_value)) +
  geom_pointrange(aes(x=bin_midpoint, y=q50, ymin=q025, ymax=q975), color = 'red') +
  scale_x_log10() + scale_y_log10()
